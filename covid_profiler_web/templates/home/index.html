{% import 'utils.html' as utils %}
{% extends 'base.html' %}

{% block header %}

{% endblock %}

{% block content %}
	<div class="row text-center mx-auto">
		<div class="col-md-1">

		</div>
		<div class="col-md-10 pt-4">
			<h3>COVID-Profiler</h3>
			<div class="pb-4">
				Welcome to the COVID-Profiler - a pipeline which allows users
				to analyse <i>Sars-Cov-2</i> sequencing data to place isolates within
                a real-time tree.
			</div>



			<h5 class="">How does it work?</h5>
			<div class="pb-4">
                Every hour, all publically available sequences from the current COVID-19
                outbreak are downloaded and a maximum likelihood tree is built. Users can
                upload their own sequences to look where they are positioned on the tree.
				The pipeline searches for SNPs associated with branches on the tree.
                It then uses the variants to find the closest neighbours on the tree.
                In parallel it classifies the strains into S/L types as defined by
                <a href="https://academic.oup.com/nsr/advance-article/doi/10.1093/nsr/nwaa036/5775463">Tang et al</a>.
			</div>



            <div class="row justify-content-md-center">
                <div class="col-md-10 pb-4">
                    <div class="card border-dark text-center">
                      <div class="card-header">
                        Real-time tree
                      </div>
                      <div class="card-body">
                        <svg id="tree_display"></svg>
                      </div>
                      <div class="card-footer text-muted">
                          Last updated: {{ tree["created"] }}
                      </div>
                    </div>
                </div>
            </div>



			<div class="row justify-content-md-center">
				<div class="col-md-6 pb-4">
					<div class="card border-dark text-center">
					  <div class="card-header">
					    Step 1
					  </div>
					  <div class="card-body">
					    <h5 class="card-title">Profile your sample</h5>

									<p class="card-text">
										Upload your sequencing data in <b>fasta</b> format.
									</p>


					    <a class="btn btn-primary" href="{{ url_for('upload.upload') }}">Upload</a>
					  </div>
					</div>
				</div>
			</div>


			<div class="row justify-content-md-center">
				<div class="col-md-6 pb-4">
					<div class="card border-dark text-center">
					  <div class="card-header">
					    Step 2
					  </div>
					  <div class="card-body">
					    <h5 class="card-title">View the results</h5>

									<p class="card-text">
										Find your results by entering your unique run ID directly into the search box below.
									</p>

							<form method="post" enctype=multipart/form-data>
								<div class="row justify-content-md-center">
									<div class="col-md-6">
										<input type="text" name="sample_id" class="form-control" placeholder="Sample ID">
									</div>
									<button type="submit" class="btn btn-primary">Submit</button>
								</div>
							</form>
					  </div>
					</div>
				</div>
			</div>



            <hr>
			<h5 class="">Pipeline</h5>
			<div class="text-left">
                Sequences are aligned to the reference genome (NC_045512.2) using minimap2 [1].
                Variants are called using paftools.js from the minimap2 package and bcftools [2]
                and transformed into a fasta alignment. IQ-TREE [3] is used to reconstruct the
                phylogeny. Custom scripts utilising ete3 [4] are used to position new isolates
                on the tree which are visualised using phylotree.js [5] in the web browser.
                Sample data is downloaded from NCBI nucleotide database using <a href="https://www.ncbi.nlm.nih.gov/books/NBK179288/">Entrez Direct</a>.
                The website is built using <a href="https://github.com/pallets/flask">flask</a>.
                All the code is available from <a href="https://github.com/jodyphelan/covid-profiler">https://github.com/jodyphelan/covid-profiler</a>.
                <div class="pt-4">
                    <ol>
                        <li>Li, H. Minimap2: Pairwise alignment for nucleotide sequences. <i>Bioinformatics</i> <b>34</b>, 3094–3100 (2018).</li>
                        <li>Li, H. A statistical framework for SNP calling, mutation discovery, association mapping and population genetical parameter estimation from sequencing data. <i>Bioinformatics</i> <b>27</b>, 2987–2993 (2011).</li>
                        <li>Minh, B. Q. et al. IQ-TREE 2: New models and efficient methods for phylogenetic inference in the genomic era. <i>Mol. Biol. Evol.</i> (2020). doi:10.1093/molbev/msaa015</li>
                        <li>Huerta-Cepas, J., Serra, F. & Bork, P. ETE 3: Reconstruction, Analysis, and Visualization of Phylogenomic Data. <i>Mol. Biol. Evol.</i> <b>33</b>, 1635–8 (2016).</li>
                        <li>Shank, S. D., Weaver, S. & Kosakovsky Pond, S. L. phylotree.js - a JavaScript library for application development and interactive data visualization in phylogenetics. <i>BMC Bioinformatics</i> <b>19</b>, 276 (2018).</li>
                    </ol>
                </div>
			</div>


			<hr>
			<h6 class="">Disclaimer</h6>
			<div class="">
				This tool is for Research Use Only. It has not been approved, cleared,
				or licensed by any regulatory authority. By submitting sequence data the
				 user acknowledges no intended medical purpose or objective such as
				 clinical diagnosis, patient management, or human clinical trials.
			</div>
		</div>
	</div>

    <script type="text/javascript">
    var data = '{{ tree["meta"] | safe }}'
    var tree_meta = JSON.parse(data)
    var example_tree = '{{ tree["newick"] }}'
    var height = 500;
    var width = $( "#tree_display" ).parent().width()-40;
    var tree = d3.layout.phylotree()
      .svg(d3.select("#tree_display"))
      .options({
        'left-right-spacing': 'fit-to-size',
        'top-bottom-spacing': 'fit-to-size',
        'collapsible': false,
        'transitions': false,
        'zoom':true
      })
      .size([height, width])


     tree(example_tree);


     var attribute_to_color = d3.scale.category10();
     var tree_attributes = {};
     var maximum_length = 0;

      tree.traverse_and_compute (function (node) {
          if (d3.layout.phylotree.is_leafnode (node)) {
            tree_attributes[node.name] = [tree_meta[node.name]["country"]]
            maximum_length = maximum_length < node.name.length ? node.name.length : maximum_length;
          }
        });




      tree.style_nodes(function(element, node_data){
          if (node_data.name in tree_attributes) {
              var node_label = element.select("text")
              node_label[0][0].attributes.dx.nodeValue = "5"
              var font_size  = parseFloat (node_label.style ("font-size"));
              var annotation = element.selectAll ("circle").data (tree_attributes[node_data.name]);
              annotation.enter().append ("circle");
              annotation.attr ("r", 3)
              .attr("data-legend",function(d,i) { return d})
              .style ("fill", function(d, i) {
                  return attribute_to_color (d);
             });



         }
      })
      .layout()

      svg = d3.selectAll("svg")
      legend_offset = parseFloat(svg.style("width"))-100
      legend = svg.append("g")
          .attr("class","legend")
          .attr("transform","translate("+legend_offset+",50)")
          .style("font-size","12px")
          .call(d3.legend)

      reset = svg.append("g")
        .attr("transform","translate("+legend_offset+",200)")
        .append("text")
        .text("Reset view")
        .style("font-size","12px")

      reset.on("click",function(d){
          tree.update()
      })

      var div = d3.select("body").append("div")
        .attr("class", "card tooltip-card")
        .style("opacity", 0);

      var nodes = d3.selectAll(".node")
      nodes.on("mouseover",function(d){
        div.transition()
          .duration(200)
          .style("opacity", .9);
        var htmlString = "<strong>ID:</strong> " +d.name;
        var htmlString = htmlString+"<br><strong>Country:</strong> " + tree_meta[d.name]["country"];
        var htmlString = htmlString+"<br><strong>Date of collection:</strong> " + tree_meta[d.name]["collection_date"];
        div.attr("height", 18*htmlString.split("<br>").length)
        div.html(htmlString)

          .style("left", (d3.event.pageX) + "px")
          .style("top", (d3.event.pageY - 28) + "px");
      })
      .on("mouseout",function(d){

        div.transition()
          .duration(500)
          .style("opacity", 0);
      })

    </script>

{% endblock %}
